# Branch Skillのデモンストレーション
# BranchSkillは条件に応じて異なるスキルを実行
# 最初にマッチした分岐のみ実行される

# ======================================
# 基本的な分岐
# ======================================
BasicBranchMob:
  Type: ZOMBIE
  Display: '&eBasic Branch Example'
  Health: 100

  Skills:
    OnTimer:
      # プレイヤー数で分岐
      - name: PlayerCountBranch
        interval: 5s
        type: Branch
        branches:
          # 3人以上: 範囲攻撃
          - condition: "nearbyPlayers.count >= 3"
            targeter:
              type: Area
              shape: CIRCLE
              radius: "10.0"
            skills:
              - skill: CircleExplosion

          # 1-2人: 単体攻撃
          - condition: "nearbyPlayers.count > 0"
            targeter:
              type: NearestPlayer
              range: 20
            skills:
              - skill: StrongAttack

          # デフォルト: 待機
          - default: true
            targeter:
              type: Self
            skills:
              - skill: Idle

# ======================================
# HP段階による分岐
# ======================================
HealthPhaseBoss:
  Type: WITHER_SKELETON
  Display: '&4&lPhase Boss'
  Health: 300

  Skills:
    OnTimer:
      # HP段階で攻撃パターンを変更
      - name: PhaseAttack
        interval: 2s
        type: Branch
        branches:
          # フェーズ1: HP > 70%
          - condition: "entity.health > entity.maxHealth * 0.7"
            targeter:
              type: NearestPlayer
              range: 15
            skills:
              - skill: NormalAttack
              - skill: OccasionalFireball

          # フェーズ2: HP 30-70%
          - condition: "entity.health > entity.maxHealth * 0.3"
            targeter:
              type: RadiusPlayers
              range: 20
            skills:
              - skill: PowerAttack
              - skill: SummonMinions

          # フェーズ3: HP < 30%
          - default: true  # HP < 30%
            targeter:
              type: Area
              shape: CIRCLE
              radius: "15.0"
            skills:
              - skill: BerserkMode
              - skill: AreaExplosion
              - skill: RapidSummon

# ======================================
# プレイヤーレベルによる分岐
# ======================================
LevelAdaptiveMob:
  Type: SKELETON
  Display: '&7Level Adaptive Mob'
  Health: 120

  Skills:
    OnTimer:
      # プレイヤーのレベルで難易度調整
      - name: LevelBasedAttack
        interval: 3s
        type: Branch
        branches:
          # 高レベルプレイヤー向け
          - condition: "nearbyPlayers.avgLevel >= 30"
            targeter:
              type: RadiusPlayers
              range: 25
              filter: "target.level >= 20"
            skills:
              - skill: HardModeAttack
              - skill: DebuffSkill

          # 中レベルプレイヤー向け
          - condition: "nearbyPlayers.avgLevel >= 15"
            targeter:
              type: NearestPlayer
              range: 20
            skills:
              - skill: NormalAttack

          # 低レベルプレイヤー向け
          - default: true
            targeter:
              type: NearestPlayer
              range: 15
            skills:
              - skill: EasyAttack
              - skill: Warning  # 警告を出す

# ======================================
# 距離による分岐
# ======================================
RangeAdaptiveMob:
  Type: CREEPER
  Display: '&aRange Adaptive'
  Health: 80

  Skills:
    OnTimer:
      # ターゲットとの距離で行動変更
      - name: DistanceBehavior
        interval: 1s
        type: Branch
        branches:
          # 近距離: 爆発
          - condition: >
              nearbyPlayers.count > 0 &&
              distance.horizontal(
                entity.location,
                world.getNearbyEntities(entity.location, 5, 5, 5)
                  .filterIsInstance<Player>()
                  .minByOrNull { it.location.distanceSquared(entity.location) }?.location
              ) < 3.0
            targeter:
              type: Self
            skills:
              - skill: Explode

          # 中距離: 接近
          - condition: >
              nearbyPlayers.count > 0 &&
              distance.horizontal(...) >= 3.0 &&
              distance.horizontal(...) < 10.0
            targeter:
              type: NearestPlayer
              range: 15
            skills:
              - skill: MoveTowards

          # 遠距離: 待機
          - default: true
            targeter:
              type: Self
            skills:
              - skill: Idle

# ======================================
# 時間・環境による分岐
# ======================================
EnvironmentMob:
  Type: PHANTOM
  Display: '&9Environment Reactive'
  Health: 100

  Skills:
    OnTimer:
      # 時間帯・天候で行動変更
      - name: EnvironmentBehavior
        interval: 3s
        type: Branch
        branches:
          # 雷雨時: 強力攻撃
          - condition: "world.isThundering"
            targeter:
              type: Chain
              initialTargeter:
                type: NearestPlayer
                range: 25
              maxChains: "8"
              chainRange: "7.0"
            skills:
              - skill: ThunderStrike

          # 満月の夜: 特殊攻撃
          - condition: "world.isNight && environment.moonPhase == 0"
            targeter:
              type: Area
              shape: CIRCLE
              radius: "15.0"
            skills:
              - skill: FullMoonBlast

          # 夜間: 通常攻撃
          - condition: "world.isNight"
            targeter:
              type: RadiusPlayers
              range: 20
            skills:
              - skill: NightAttack

          # 昼間: 弱体化
          - default: true
            targeter:
              type: NearestPlayer
              range: 10
            skills:
              - skill: WeakAttack

# ======================================
# 複雑な条件分岐
# ======================================
ComplexBranchBoss:
  Type: ENDER_DRAGON
  Display: '&5&l&oComplex Branch Boss'
  Health: 500

  Skills:
    OnTimer:
      # 複数の条件を組み合わせた高度な分岐
      - name: ComplexBranching
        interval: 2s
        type: Branch
        branches:
          # 緊急モード: HP低い かつ 多数のプレイヤー
          - condition: >
              entity.health < entity.maxHealth * 0.2 &&
              nearbyPlayers.count >= 3
            targeter:
              type: Area
              shape: DONUT
              innerRadius: "3.0"
              radius: "25.0"
            skills:
              - skill: EmergencyBarrier
              - skill: MassiveSummon
              - skill: DesperationAttack

          # 強モード: HP高い かつ 高レベルプレイヤー
          - condition: >
              entity.health > entity.maxHealth * 0.5 &&
              nearbyPlayers.maxLevel >= 30
            targeter:
              type: Chain
              initialTargeter:
                type: RadiusPlayers
                range: 30
                filter: "target.level >= 20"
              maxChains: "10"
              chainRange: "8.0"
            skills:
              - skill: EliteModeAttack
              - skill: AdvancedTactics

          # 通常モード: それ以外
          - default: true
            targeter:
              type: RadiusPlayers
              range: 25
            skills:
              - skill: StandardAttack

# ======================================
# ランダム要素を含む分岐
# ======================================
RandomBranchMob:
  Type: WITCH
  Display: '&dRandom Branch Witch'
  Health: 100

  Skills:
    OnTimer:
      # 確率による分岐
      - name: RandomChoice
        interval: 4s
        type: Branch
        branches:
          # 30%の確率で強力攻撃
          - condition: "random.chance(0.3)"
            targeter:
              type: Area
              shape: CIRCLE
              radius: "12.0"
            skills:
              - skill: PowerfulPotion

          # 40%の確率で召喚
          - condition: "random.chance(0.571)"  # 残り70%の40% = 0.4/0.7
            targeter:
              type: Self
            skills:
              - skill: SummonAllies

          # 30%の確率で回復
          - default: true
            targeter:
              type: Self
            skills:
              - skill: HealSelf

# ======================================
# ネストした条件分岐（複数のBranch使用）
# ======================================
NestedBranchBoss:
  Type: RAVAGER
  Display: '&4&l&oNested Branch Boss'
  Health: 400

  Skills:
    OnTimer:
      # 第1段階: HP判定
      - name: HealthCheck
        interval: 2s
        type: Branch
        branches:
          - condition: "entity.health > entity.maxHealth * 0.5"
            targeter:
              type: Self
            skills:
              # HP高い時: プレイヤー数で分岐
              - name: PlayerCountCheckHigh
                type: Branch
                branches:
                  - condition: "nearbyPlayers.count >= 3"
                    targeter:
                      type: Area
                      shape: CIRCLE
                      radius: "10.0"
                    skills:
                      - skill: AOEAttack

                  - default: true
                    targeter:
                      type: NearestPlayer
                      range: 15
                    skills:
                      - skill: SingleTargetAttack

          - default: true
            targeter:
              type: Self
            skills:
              # HP低い時: より攻撃的
              - name: PlayerCountCheckLow
                type: Branch
                branches:
                  - condition: "nearbyPlayers.count >= 2"
                    targeter:
                      type: Chain
                      initialTargeter:
                        type: NearestPlayer
                        range: 20
                      maxChains: "nearbyPlayers.count"
                      chainRange: "7.0"
                    skills:
                      - skill: ChainAttack

                  - default: true
                    targeter:
                      type: NearestPlayer
                      range: 15
                    skills:
                      - skill: DesperationAttack
